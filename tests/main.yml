---
# Tasks for testing role

- name: Setup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      docker_presets_images_json_query: >-
        [? starts_with(name, `centos-6`)
           || starts_with(name, `centos-7`)
           || starts_with(name, `fedora-29`)
           || starts_with(name, `fedora-30`) ]

    - role: amtega.docker_sandbox
      docker_sandbox_state: started
  tags:
    - sandbox

- name: Test tftpd role
  hosts: docker_sandbox_containers
  roles:
    - amtega.tftpd
  vars:
    tftpd_testfile_dir: /tmp
    tftpd_testfile_name: tftpd_testfile1

  tasks:
    - name: Install tftp client
      package:
        name: tftp
        state: present

    - name: Create test file in tftpd root
      copy:
        content: "Hello World"
        dest: "{{ tftpd_root_directory }}/{{ tftpd_testfile_name }}"
        force: yes

    - name: Get test file using tftp client
      command: >-
        tftp {{ ansible_default_ipv4.address }}
        -c
        get {{ tftpd_testfile_name }}
      args:
        chdir: "{{ tftpd_testfile_dir }}"
        creates: "{{ tftpd_testfile_dir }}/{{ tftpd_testfile_name }}"
  tags:
    - idempotence

- name: Cleanup testing sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: absent
  tags:
    - cleanup
    - sandbox
